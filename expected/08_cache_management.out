CREATE EXTENSION pg_kmersearch;
-- Test cache management functionality
-- This test covers actual min score cache, rawscore cache, and query pattern cache
-- Clean up any existing tables
DROP TABLE IF EXISTS test_cache_DNA2, test_cache_DNA4 CASCADE;
NOTICE:  table "test_cache_dna2" does not exist, skipping
NOTICE:  table "test_cache_dna4" does not exist, skipping
-- Create test tables for cache testing
CREATE TABLE test_cache_DNA2 (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA2
);
CREATE TABLE test_cache_DNA4 (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA4
);
-- Insert test data for cache testing
INSERT INTO test_cache_DNA2 (name, sequence) VALUES
    ('cache_seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('cache_seq2', 'TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT'),
    ('cache_seq3', 'ATCGATCGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT'),
    ('cache_seq4', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('cache_seq5', 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
INSERT INTO test_cache_DNA4 (name, sequence) VALUES
    ('cache_seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('cache_seq2', 'TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT'),
    ('cache_seq3', 'ATCGATCGNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN'),
    ('cache_seq4', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('cache_seq5', 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
-- Create GIN indexes for testing
CREATE INDEX test_cache_dna2_gin_idx ON test_cache_DNA2 USING gin (sequence);
CREATE INDEX test_cache_dna4_gin_idx ON test_cache_DNA4 USING gin (sequence);
-- Test GUC configuration for cache settings
SHOW kmersearch.actual_min_score_cache_max_entries;
 kmersearch.actual_min_score_cache_max_entries 
-----------------------------------------------
 50000
(1 row)

SET kmersearch.actual_min_score_cache_max_entries = 1000;
SHOW kmersearch.actual_min_score_cache_max_entries;
 kmersearch.actual_min_score_cache_max_entries 
-----------------------------------------------
 1000
(1 row)

SHOW kmersearch.rawscore_cache_max_entries;
 kmersearch.rawscore_cache_max_entries 
---------------------------------------
 50000
(1 row)

SET kmersearch.rawscore_cache_max_entries = 2000;
SHOW kmersearch.rawscore_cache_max_entries;
 kmersearch.rawscore_cache_max_entries 
---------------------------------------
 2000
(1 row)

SHOW kmersearch.query_pattern_cache_max_entries;
 kmersearch.query_pattern_cache_max_entries 
--------------------------------------------
 50000
(1 row)

SET kmersearch.query_pattern_cache_max_entries = 3000;
SHOW kmersearch.query_pattern_cache_max_entries;
 kmersearch.query_pattern_cache_max_entries 
--------------------------------------------
 3000
(1 row)

-- Reset to defaults for consistent testing
SET kmersearch.actual_min_score_cache_max_entries = 50000;
SET kmersearch.rawscore_cache_max_entries = 50000;
SET kmersearch.query_pattern_cache_max_entries = 50000;
-- Test initial cache statistics (should be empty)
SELECT 'Initial actual min score cache:' as test_phase;
           test_phase            
---------------------------------
 Initial actual min score cache:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

SELECT 'Initial rawscore cache:' as test_phase;
       test_phase        
-------------------------
 Initial rawscore cache:
(1 row)

SELECT * FROM kmersearch_rawscore_cache_stats();
 dna2_hits | dna2_misses | dna2_entries | dna2_max_entries | dna4_hits | dna4_misses | dna4_entries | dna4_max_entries 
-----------+-------------+--------------+------------------+-----------+-------------+--------------+------------------
         0 |           0 |            0 |                0 |         0 |           0 |            0 |                0
(1 row)

SELECT 'Initial query pattern cache:' as test_phase;
          test_phase          
------------------------------
 Initial query pattern cache:
(1 row)

SELECT * FROM kmersearch_query_pattern_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

-- Execute some queries to populate caches
SELECT 'Populating caches with queries...' as test_phase;
            test_phase             
-----------------------------------
 Populating caches with queries...
(1 row)

-- Same query multiple times to test actual min score caching
SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

-- Different queries to test cache diversity
SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'TTTTTTTT';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'TTTTTTTT';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'GCTAGCTA';
 count 
-------
     1
(1 row)

-- DNA4 queries
SELECT COUNT(*) FROM test_cache_DNA4 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_DNA4 WHERE sequence =% 'NNNNNNNN';
 count 
-------
     0
(1 row)

-- Test scoring functions to populate rawscore cache
SELECT kmersearch_rawscore(sequence, 'ATCGATCG') FROM test_cache_DNA2 WHERE id <= 2;
 kmersearch_rawscore 
---------------------
                  14
                   0
(2 rows)

SELECT kmersearch_rawscore(sequence, 'TTTTTTTT') FROM test_cache_DNA2 WHERE id <= 2;
 kmersearch_rawscore 
---------------------
                   0
                  53
(2 rows)

-- Check cache statistics after usage
SELECT 'After query execution - actual min score cache:' as test_phase;
                   test_phase                    
-------------------------------------------------
 After query execution - actual min score cache:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
   59 |      3 |               3 |       50000
(1 row)

SELECT 'After query execution - rawscore cache:' as test_phase;
               test_phase                
-----------------------------------------
 After query execution - rawscore cache:
(1 row)

SELECT * FROM kmersearch_rawscore_cache_stats();
 dna2_hits | dna2_misses | dna2_entries | dna2_max_entries | dna4_hits | dna4_misses | dna4_entries | dna4_max_entries 
-----------+-------------+--------------+------------------+-----------+-------------+--------------+------------------
         8 |          26 |            7 |            50000 |         0 |          10 |            7 |            50000
(1 row)

SELECT 'After query execution - query pattern cache:' as test_phase;
                  test_phase                  
----------------------------------------------
 After query execution - query pattern cache:
(1 row)

SELECT * FROM kmersearch_query_pattern_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

-- Test cache clearing functions
SELECT 'Testing cache clear functions...' as test_phase;
            test_phase            
----------------------------------
 Testing cache clear functions...
(1 row)

SELECT 'Clearing actual min score cache:' as action, kmersearch_actual_min_score_cache_free() as freed_entries;
              action              | freed_entries 
----------------------------------+---------------
 Clearing actual min score cache: |             3
(1 row)

SELECT 'Clearing rawscore cache:' as action, kmersearch_rawscore_cache_free() as freed_entries;
          action          | freed_entries 
--------------------------+---------------
 Clearing rawscore cache: |            14
(1 row)

SELECT 'Clearing query pattern cache:' as action, kmersearch_query_pattern_cache_free() as freed_entries;
            action             | freed_entries 
-------------------------------+---------------
 Clearing query pattern cache: |             0
(1 row)

-- Verify caches are cleared
SELECT 'After clearing - actual min score cache:' as test_phase;
                test_phase                
------------------------------------------
 After clearing - actual min score cache:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

SELECT 'After clearing - rawscore cache:' as test_phase;
            test_phase            
----------------------------------
 After clearing - rawscore cache:
(1 row)

SELECT * FROM kmersearch_rawscore_cache_stats();
 dna2_hits | dna2_misses | dna2_entries | dna2_max_entries | dna4_hits | dna4_misses | dna4_entries | dna4_max_entries 
-----------+-------------+--------------+------------------+-----------+-------------+--------------+------------------
         0 |           0 |            0 |                0 |         0 |           0 |            0 |                0
(1 row)

SELECT 'After clearing - query pattern cache:' as test_phase;
              test_phase               
---------------------------------------
 After clearing - query pattern cache:
(1 row)

SELECT * FROM kmersearch_query_pattern_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

-- Test cache behavior with different min_score settings
SELECT 'Testing with different min_score settings...' as test_phase;
                  test_phase                  
----------------------------------------------
 Testing with different min_score settings...
(1 row)

SET kmersearch.min_score = 5;
SET kmersearch.min_shared_ngram_key_rate = 0.8;
-- Execute queries with new settings
SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

-- Check cache after configuration change
SELECT 'With changed settings - actual min score cache:' as test_phase;
                   test_phase                    
-------------------------------------------------
 With changed settings - actual min score cache:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
   11 |      1 |               1 |       50000
(1 row)

-- Reset to defaults
SET kmersearch.min_score = 1;
SET kmersearch.min_shared_ngram_key_rate = 0.9;
-- Test edge cases for cache limits
SELECT 'Testing cache limit behavior...' as test_phase;
           test_phase            
---------------------------------
 Testing cache limit behavior...
(1 row)

-- Set very small cache limit (minimum allowed is 1000)
SET kmersearch.actual_min_score_cache_max_entries = 1000;
-- Clear cache first
SELECT kmersearch_actual_min_score_cache_free();
 kmersearch_actual_min_score_cache_free 
----------------------------------------
                                      0
(1 row)

-- Execute multiple different queries to test eviction
SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'AAAAAAAA';
 count 
-------
     1
(1 row)

SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'TTTTTTTT';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'CCCCCCCC';
 count 
-------
     0
(1 row)

SELECT COUNT(*) FROM test_cache_DNA2 WHERE sequence =% 'GGGGGGGG';
 count 
-------
     0
(1 row)

-- Check final cache state
SELECT 'Final cache state:' as test_phase;
     test_phase     
--------------------
 Final cache state:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
   32 |      4 |               4 |        1000
(1 row)

-- Clean up
DROP TABLE test_cache_DNA2, test_cache_DNA4 CASCADE;
