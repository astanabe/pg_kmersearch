-- Enhanced parallel cache test with actual high-frequency k-mers
CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Create test table with many repeated sequences to ensure high-frequency k-mers
CREATE TABLE test_parallel_enhanced (
    id SERIAL PRIMARY KEY,
    seq dna2
);
-- Insert many sequences with the same k-mers to create high frequency
DO $$
BEGIN
    FOR i IN 1..50 LOOP
        INSERT INTO test_parallel_enhanced (seq) VALUES ('ATCGATCGATCGATCGATCGATCGATCGATCG'::dna2);
        INSERT INTO test_parallel_enhanced (seq) VALUES ('GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCT'::dna2);
    END LOOP;
END $$;
-- Set parameters to detect high-frequency k-mers
SET kmersearch.kmer_size = 8;
SET kmersearch.occur_bitlen = 8;
SET kmersearch.max_appearance_rate = 0.1;  -- Allow up to 10% appearance rate
SET kmersearch.max_appearance_nrow = 10;   -- k-mers appearing in > 10 rows are high-frequency
-- Perform analysis
SELECT 'Performing k-mer frequency analysis...' AS status;
                 status                 
----------------------------------------
 Performing k-mer frequency analysis...
(1 row)

SELECT kmersearch_analyze_table(
    (SELECT oid FROM pg_class WHERE relname = 'test_parallel_enhanced')::oid,
    'seq'::text,
    8::integer
) AS analysis_result;
NOTICE:  Performing k-mer frequency analysis for k=8
NOTICE:  Max appearance rate: 0.100000, Max appearance nrow: 10
NOTICE:  Phase 1: Analyzing k-mer frequencies with 1 parallel workers...
NOTICE:  Phase 2: Collecting n-gram keys for high-frequency k-mers...
   analysis_result   
---------------------
 (100,93,1,0,0.1,10)
(1 row)

-- Check analysis results
SELECT 'Analysis results:' AS status;
      status       
-------------------
 Analysis results:
(1 row)

SELECT highfreq_kmer_count FROM kmersearch_analysis_status WHERE table_name = 'test_parallel_enhanced';
 highfreq_kmer_count 
---------------------
                   0
(1 row)

-- Insert some manual high-frequency k-mer entries to ensure we have data
INSERT INTO kmersearch_highfreq_kmer (index_oid, ngram_key, detection_reason)
SELECT 
    (SELECT indexrelid FROM pg_stat_user_indexes WHERE relname = 'test_parallel_enhanced' LIMIT 1),
    substring(('01010101010101010101010101010101'::bit(32))::text::bit varying, 1, 24),  -- Sample 24-bit n-gram key
    'manual_test_entry'
WHERE EXISTS (SELECT 1 FROM pg_stat_user_indexes WHERE relname = 'test_parallel_enhanced');
-- Test Phase 1: Load global cache
SELECT 'Phase 1: Loading global cache...' AS test_phase;
            test_phase            
----------------------------------
 Phase 1: Loading global cache...
(1 row)

SELECT kmersearch_highfreq_kmers_cache_load(
    (SELECT oid FROM pg_class WHERE relname = 'test_parallel_enhanced')::oid,
    'seq'::text,
    8::integer
) AS global_cache_loaded;
 global_cache_loaded 
---------------------
 t
(1 row)

-- Test Phase 2: Load parallel cache
SELECT 'Phase 2: Loading parallel cache...' AS test_phase;
             test_phase             
------------------------------------
 Phase 2: Loading parallel cache...
(1 row)

SELECT kmersearch_parallel_highfreq_kmers_cache_load(
    (SELECT oid FROM pg_class WHERE relname = 'test_parallel_enhanced')::oid,
    'seq'::text,
    8::integer
) AS parallel_cache_loaded;
 parallel_cache_loaded 
-----------------------
 t
(1 row)

-- Test Phase 3: Functional testing
SELECT 'Phase 3: Testing search functionality...' AS test_phase;
                test_phase                
------------------------------------------
 Phase 3: Testing search functionality...
(1 row)

-- Enable high-frequency k-mer exclusion and test different cache modes
SET kmersearch.preclude_highfreq_kmer = true;
-- Test with global cache only
SET kmersearch.force_use_dshash = false;
SELECT 'Testing with global cache:' AS cache_type;
         cache_type         
----------------------------
 Testing with global cache:
(1 row)

SELECT COUNT(*) AS results FROM test_parallel_enhanced WHERE seq =% 'ATCGATCG';
 results 
---------
      50
(1 row)

-- Test with parallel cache (force dshash)
SET kmersearch.force_use_dshash = true;
SELECT 'Testing with parallel cache:' AS cache_type;
          cache_type          
------------------------------
 Testing with parallel cache:
(1 row)

SELECT COUNT(*) AS results FROM test_parallel_enhanced WHERE seq =% 'ATCGATCG';
 results 
---------
      50
(1 row)

-- Test Phase 4: Cache isolation testing
SELECT 'Phase 4: Testing cache isolation...' AS test_phase;
             test_phase              
-------------------------------------
 Phase 4: Testing cache isolation...
(1 row)

-- Clear global cache and test parallel cache only
SELECT kmersearch_highfreq_kmers_cache_free() AS global_cache_freed;
 global_cache_freed 
--------------------
                  1
(1 row)

SELECT 'Testing parallel cache after global cache freed:' AS test_description;
                 test_description                 
--------------------------------------------------
 Testing parallel cache after global cache freed:
(1 row)

SELECT COUNT(*) AS results FROM test_parallel_enhanced WHERE seq =% 'ATCGATCG';
 results 
---------
      50
(1 row)

-- Test Phase 5: Raw score verification
SELECT 'Phase 5: Testing rawscore calculations...' AS test_phase;
                test_phase                 
-------------------------------------------
 Phase 5: Testing rawscore calculations...
(1 row)

SELECT id, 
       kmersearch_rawscore(seq, 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA') AS rawscore
FROM test_parallel_enhanced 
WHERE seq =% 'ATCGATCG' 
LIMIT 5;
 id | rawscore 
----+----------
  1 |       25
  3 |       25
  5 |       25
  7 |       25
  9 |       25
(5 rows)

-- Test Phase 6: Cache cleanup and fallback
SELECT 'Phase 6: Testing cache cleanup and fallback...' AS test_phase;
                   test_phase                   
------------------------------------------------
 Phase 6: Testing cache cleanup and fallback...
(1 row)

-- Free parallel cache
SELECT kmersearch_parallel_highfreq_kmers_cache_free() AS parallel_cache_freed;
 parallel_cache_freed 
----------------------
                    1
(1 row)

-- Test fallback to table lookup
SET kmersearch.force_use_dshash = false;
SELECT 'Testing table lookup fallback:' AS test_description;
        test_description        
--------------------------------
 Testing table lookup fallback:
(1 row)

SELECT COUNT(*) AS results FROM test_parallel_enhanced WHERE seq =% 'ATCGATCG';
 results 
---------
      50
(1 row)

-- Final cleanup
SELECT 'Cleanup: Removing test data...' AS cleanup_phase;
         cleanup_phase          
--------------------------------
 Cleanup: Removing test data...
(1 row)

DROP TABLE test_parallel_enhanced CASCADE;
SELECT kmersearch_highfreq_kmers_cache_free() AS final_cleanup;
 final_cleanup 
---------------
             0
(1 row)

SELECT 'Enhanced parallel cache test completed!' AS final_status;
              final_status               
-----------------------------------------
 Enhanced parallel cache test completed!
(1 row)

DROP EXTENSION pg_kmersearch CASCADE;
