-- Enhanced parallel cache test with actual high-frequency k-mers
CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Create test table with many repeated sequences to ensure high-frequency k-mers
CREATE TABLE test_parallel_enhanced (
    id SERIAL PRIMARY KEY,
    seq dna2
);
-- Insert many sequences with the same k-mers to create high frequency
DO $$
BEGIN
    FOR i IN 1..30 LOOP
        INSERT INTO test_parallel_enhanced (seq) VALUES ('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'::dna2);
        INSERT INTO test_parallel_enhanced (seq) VALUES ('TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT'::dna2);
        INSERT INTO test_parallel_enhanced (seq) VALUES ('CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC'::dna2);
        INSERT INTO test_parallel_enhanced (seq) VALUES ('GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGG'::dna2);
    END LOOP;
END $$;
-- Set parameters to detect high-frequency k-mers
SET kmersearch.kmer_size = 4;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 4
(1 row)

SET kmersearch.occur_bitlen = 8;
SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 8
(1 row)

SET kmersearch.max_appearance_rate = 0.2;   -- Allow up to 20% appearance rate  
SHOW kmersearch.max_appearance_rate;
 kmersearch.max_appearance_rate 
--------------------------------
 0.2
(1 row)

SET kmersearch.max_appearance_nrow = 20;   -- k-mers appearing in > 20 rows are high-frequency
SHOW kmersearch.max_appearance_nrow;
 kmersearch.max_appearance_nrow 
--------------------------------
 20
(1 row)

SET kmersearch.min_shared_ngram_key_rate = 0.2;  -- Allow matches with 20% shared k-mers
SHOW kmersearch.min_shared_ngram_key_rate;
 kmersearch.min_shared_ngram_key_rate 
--------------------------------------
 0.2
(1 row)

-- Perform analysis
SELECT 'Performing k-mer frequency analysis...' AS status;
                 status                 
----------------------------------------
 Performing k-mer frequency analysis...
(1 row)

SELECT kmersearch_perform_highfreq_analysis(
    'test_parallel_enhanced'::text,
    'seq'::text
) AS analysis_result;
NOTICE:  Performing k-mer frequency analysis for k=4
NOTICE:  Max appearance rate: 0.200000, Max appearance nrow: 20
NOTICE:  Phase 1: Analyzing k-mer frequencies with 2 parallel workers...
NOTICE:  table "temp_kmer_final_3092351_1752640568_480382_3" does not exist, skipping
NOTICE:  Phase 2: Collecting n-gram keys for high-frequency k-mers...
NOTICE:  Source table temp_ngram_keys_3092351_1752640568_481855_4 contains 5 n-gram key records
NOTICE:  Successfully inserted 5 n-gram key records
NOTICE:  High-frequency k-mer analysis transaction committed successfully
  analysis_result   
--------------------
 (120,4,2,0,0.2,20)
(1 row)

-- Check analysis results
SELECT 'Analysis results:' AS status;
      status       
-------------------
 Analysis results:
(1 row)

SELECT highfreq_kmer_count FROM kmersearch_analysis_status WHERE table_name = 'test_parallel_enhanced';
 highfreq_kmer_count 
---------------------
                   5
(1 row)

-- Verify that analysis detected high-frequency k-mers
SELECT 'Verifying analysis results:' AS status;
           status            
-----------------------------
 Verifying analysis results:
(1 row)

SELECT highfreq_kmer_count, max_appearance_rate, max_appearance_nrow 
FROM kmersearch_analysis_status 
WHERE table_name = 'test_parallel_enhanced' AND column_name = 'seq';
 highfreq_kmer_count | max_appearance_rate | max_appearance_nrow 
---------------------+---------------------+---------------------
                   5 |                 0.2 |                  20
(1 row)

-- Test Phase 1: Load global cache
SELECT 'Phase 1: Loading global cache...' AS test_phase;
            test_phase            
----------------------------------
 Phase 1: Loading global cache...
(1 row)

SELECT kmersearch_highfreq_kmer_cache_load(
    'test_parallel_enhanced'::text,
    'seq'::text
) AS global_cache_loaded;
 global_cache_loaded 
---------------------
 t
(1 row)

-- Test Phase 2: Load parallel cache
SELECT 'Phase 2: Loading parallel cache...' AS test_phase;
             test_phase             
------------------------------------
 Phase 2: Loading parallel cache...
(1 row)

SELECT kmersearch_parallel_highfreq_kmer_cache_load(
    'test_parallel_enhanced'::text,
    'seq'::text
) AS parallel_cache_loaded;
 parallel_cache_loaded 
-----------------------
 t
(1 row)

-- Test Phase 3: Functional testing
SELECT 'Phase 3: Testing search functionality...' AS test_phase;
                test_phase                
------------------------------------------
 Phase 3: Testing search functionality...
(1 row)

-- Enable high-frequency k-mer exclusion and test different cache modes
SET kmersearch.preclude_highfreq_kmer = true;
-- Test with global cache only
SET kmersearch.force_use_parallel_highfreq_kmer_cache = false;
SELECT 'Testing with global cache:' AS cache_type;
         cache_type         
----------------------------
 Testing with global cache:
(1 row)

SELECT COUNT(*) AS results FROM test_parallel_enhanced WHERE seq =% 'ATCGATCG';
 results 
---------
       0
(1 row)

-- Test with parallel cache (force dshash)
SET kmersearch.force_use_parallel_highfreq_kmer_cache = true;
SELECT 'Testing with parallel cache:' AS cache_type;
          cache_type          
------------------------------
 Testing with parallel cache:
(1 row)

SELECT COUNT(*) AS results FROM test_parallel_enhanced WHERE seq =% 'ATCGATCG';
 results 
---------
       0
(1 row)

-- Test Phase 4: Cache isolation testing
SELECT 'Phase 4: Testing cache isolation...' AS test_phase;
             test_phase              
-------------------------------------
 Phase 4: Testing cache isolation...
(1 row)

-- Clear global cache and test parallel cache only
SELECT kmersearch_highfreq_kmer_cache_free_all() AS global_cache_freed;
 global_cache_freed 
--------------------
                  1
(1 row)

SELECT 'Testing parallel cache after global cache freed:' AS test_description;
                 test_description                 
--------------------------------------------------
 Testing parallel cache after global cache freed:
(1 row)

SELECT COUNT(*) AS results FROM test_parallel_enhanced WHERE seq =% 'ATCGATCG';
 results 
---------
       0
(1 row)

-- Test Phase 5: Raw score verification
SELECT 'Phase 5: Testing rawscore calculations...' AS test_phase;
                test_phase                 
-------------------------------------------
 Phase 5: Testing rawscore calculations...
(1 row)

SELECT id, 
       kmersearch_rawscore(seq, 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA') AS rawscore
FROM test_parallel_enhanced 
WHERE seq =% 'ATCGATCG' 
LIMIT 5;
 id | rawscore 
----+----------
(0 rows)

-- Test Phase 6: Cache cleanup and fallback
SELECT 'Phase 6: Testing cache cleanup and fallback...' AS test_phase;
                   test_phase                   
------------------------------------------------
 Phase 6: Testing cache cleanup and fallback...
(1 row)

-- Free parallel cache
SELECT kmersearch_parallel_highfreq_kmer_cache_free_all() AS parallel_cache_freed;
 parallel_cache_freed 
----------------------
                    5
(1 row)

-- Test fallback to table lookup
SET kmersearch.force_use_parallel_highfreq_kmer_cache = false;
SELECT 'Testing table lookup fallback:' AS test_description;
        test_description        
--------------------------------
 Testing table lookup fallback:
(1 row)

SELECT COUNT(*) AS results FROM test_parallel_enhanced WHERE seq =% 'ATCGATCG';
 results 
---------
       0
(1 row)

-- Final cleanup
SELECT 'Cleanup: Removing test data...' AS cleanup_phase;
         cleanup_phase          
--------------------------------
 Cleanup: Removing test data...
(1 row)

DROP TABLE test_parallel_enhanced CASCADE;
SELECT kmersearch_highfreq_kmer_cache_free_all() AS final_cleanup;
 final_cleanup 
---------------
             0
(1 row)

SELECT 'Enhanced parallel cache test completed!' AS final_status;
              final_status               
-----------------------------------------
 Enhanced parallel cache test completed!
(1 row)

DROP EXTENSION pg_kmersearch CASCADE;
