SET client_min_messages = WARNING;
CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Test cache management functionality
-- This test covers actual min score cache and query pattern cache
-- Set k-mer size for consistent cache behavior
SET kmersearch.kmer_size = 4;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 4
(1 row)

SET kmersearch.min_shared_kmer_rate = 0.2;  -- Allow matches with 20% shared k-mers
SHOW kmersearch.min_shared_kmer_rate;
 kmersearch.min_shared_kmer_rate 
---------------------------------
 0.2
(1 row)

-- Clean up any existing tables
DROP TABLE IF EXISTS test_cache_dna2, test_cache_dna4 CASCADE;
-- Create test tables for cache testing
CREATE TABLE test_cache_dna2 (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA2
);
CREATE TABLE test_cache_dna4 (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA4
);
-- Insert test data for cache testing
INSERT INTO test_cache_dna2 (name, sequence) VALUES
    ('cache_seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('cache_seq2', 'TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT'),
    ('cache_seq3', 'ATCGATCGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT'),
    ('cache_seq4', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('cache_seq5', 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
INSERT INTO test_cache_dna4 (name, sequence) VALUES
    ('cache_seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('cache_seq2', 'TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT'),
    ('cache_seq3', 'ATCGATCGNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN'),
    ('cache_seq4', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('cache_seq5', 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
-- Create GIN indexes for testing
-- With k=4 and occur_bitlen=8 (default), total bits = 4*2+8 = 16, so we can use int2 operator class
CREATE INDEX test_cache_dna2_gin_idx ON test_cache_dna2 USING gin (sequence kmersearch_dna2_gin_ops_int2);
CREATE INDEX test_cache_dna4_gin_idx ON test_cache_dna4 USING gin (sequence kmersearch_dna4_gin_ops_int2);
-- Test GUC configuration for cache settings
SHOW kmersearch.actual_min_score_cache_max_entries;
 kmersearch.actual_min_score_cache_max_entries 
-----------------------------------------------
 50000
(1 row)

SET kmersearch.actual_min_score_cache_max_entries = 1000;
SHOW kmersearch.actual_min_score_cache_max_entries;
 kmersearch.actual_min_score_cache_max_entries 
-----------------------------------------------
 1000
(1 row)

SHOW kmersearch.query_kmer_cache_max_entries;
 kmersearch.query_kmer_cache_max_entries 
-----------------------------------------
 50000
(1 row)

SET kmersearch.query_kmer_cache_max_entries = 3000;
SHOW kmersearch.query_kmer_cache_max_entries;
 kmersearch.query_kmer_cache_max_entries 
-----------------------------------------
 3000
(1 row)

-- Reset to defaults for consistent testing
SET kmersearch.actual_min_score_cache_max_entries = 50000;
SET kmersearch.query_kmer_cache_max_entries = 50000;
-- Test initial cache statistics (should be empty)
SELECT 'Initial actual min score cache:' as test_phase;
           test_phase            
---------------------------------
 Initial actual min score cache:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

SELECT 'Initial query pattern cache:' as test_phase;
          test_phase          
------------------------------
 Initial query pattern cache:
(1 row)

SELECT * FROM kmersearch_query_kmer_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

-- Execute some queries to populate caches
SELECT 'Populating caches with queries...' as test_phase;
            test_phase             
-----------------------------------
 Populating caches with queries...
(1 row)

-- Same query multiple times to test actual min score caching
SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

-- Different queries to test cache diversity
SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'TTTTTTTT';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'TTTTTTTT';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'GCTAGCTA';
 count 
-------
     1
(1 row)

-- DNA4 queries
SELECT COUNT(*) FROM test_cache_dna4 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna4 WHERE sequence =% 'NNNNNNNN';
 count 
-------
     0
(1 row)

-- Test scoring functions
SELECT kmersearch_matchscore(sequence, 'ATCGATCG') FROM test_cache_dna2 WHERE id <= 2;
 kmersearch_matchscore 
-----------------------
                     5
                     0
(2 rows)

SELECT kmersearch_matchscore(sequence, 'TTTTTTTT') FROM test_cache_dna2 WHERE id <= 2;
 kmersearch_matchscore 
-----------------------
                     0
                     5
(2 rows)

-- Check cache statistics after usage
SELECT 'After query execution - actual min score cache:' as test_phase;
                   test_phase                    
-------------------------------------------------
 After query execution - actual min score cache:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
   32 |      3 |               3 |       50000
(1 row)

-- Verify that current_entries > 0 (cache is storing entries)
SELECT 'After query execution - query pattern cache:' as test_phase;
                  test_phase                  
----------------------------------------------
 After query execution - query pattern cache:
(1 row)

SELECT * FROM kmersearch_query_kmer_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
   46 |      5 |               3 |       50000
(1 row)

-- Verify that current_entries > 0 (cache is storing entries)
-- Test cache hit behavior
SELECT 'Testing cache hits...' as test_phase;
      test_phase       
-----------------------
 Testing cache hits...
(1 row)

-- Execute same queries again to test cache hits
SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA';
 count 
-------
     1
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT';
 count 
-------
     2
(1 row)

SELECT 'After cache hit tests:' as test_phase;
       test_phase       
------------------------
 After cache hit tests:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
   40 |      5 |               5 |       50000
(1 row)

-- hits should be higher now
-- Test cache clearing functions
SELECT 'Testing cache clear functions...' as test_phase;
            test_phase            
----------------------------------
 Testing cache clear functions...
(1 row)

SELECT 'Clearing actual min score cache:' as action, kmersearch_actual_min_score_cache_free() as freed_entries;
              action              | freed_entries 
----------------------------------+---------------
 Clearing actual min score cache: |             5
(1 row)

SELECT 'Clearing query pattern cache:' as action, kmersearch_query_kmer_cache_free() as freed_entries;
            action             | freed_entries 
-------------------------------+---------------
 Clearing query pattern cache: |             5
(1 row)

-- Verify caches are cleared
SELECT 'After clearing - actual min score cache:' as test_phase;
                test_phase                
------------------------------------------
 After clearing - actual min score cache:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

SELECT 'After clearing - query pattern cache:' as test_phase;
              test_phase               
---------------------------------------
 After clearing - query pattern cache:
(1 row)

SELECT * FROM kmersearch_query_kmer_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    0 |      0 |               0 |           0
(1 row)

-- Test cache behavior with different min_score settings
SELECT 'Testing with different min_score settings...' as test_phase;
                  test_phase                  
----------------------------------------------
 Testing with different min_score settings...
(1 row)

SET kmersearch.min_score = 5;
SET kmersearch.min_shared_kmer_rate = 0.8;
-- Execute queries with new settings
SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'ATCGATCG';
 count 
-------
     2
(1 row)

-- Check cache after configuration change
SELECT 'With changed settings - actual min score cache:' as test_phase;
                   test_phase                    
-------------------------------------------------
 With changed settings - actual min score cache:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
    9 |      1 |               1 |       50000
(1 row)

-- Reset to defaults
SET kmersearch.min_score = 1;
SET kmersearch.min_shared_kmer_rate = 0.2;
-- Test edge cases for cache limits
SELECT 'Testing cache limit behavior...' as test_phase;
           test_phase            
---------------------------------
 Testing cache limit behavior...
(1 row)

-- Set very small cache limit (minimum allowed is 1000)
SET kmersearch.actual_min_score_cache_max_entries = 1000;
-- Clear cache first
SELECT kmersearch_actual_min_score_cache_free();
 kmersearch_actual_min_score_cache_free 
----------------------------------------
                                      0
(1 row)

SELECT kmersearch_query_kmer_cache_free();
 kmersearch_query_kmer_cache_free 
----------------------------------
                                1
(1 row)

-- Execute multiple different queries to test eviction
SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'AAAAAAAA';
 count 
-------
     1
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'TTTTTTTT';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'CCCCCCCC';
 count 
-------
     0
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'GGGGGGGG';
 count 
-------
     0
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'AAAATTTT';
 count 
-------
     3
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'TTTTCCCC';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'CCCCGGGG';
 count 
-------
     0
(1 row)

SELECT COUNT(*) FROM test_cache_dna2 WHERE sequence =% 'GGGGAAAA';
 count 
-------
     1
(1 row)

-- Check final cache state
SELECT 'Final cache state:' as test_phase;
     test_phase     
--------------------
 Final cache state:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
   32 |      8 |               8 |        1000
(1 row)

-- current_entries should be <= max_entries
-- Test with DNA4 sequences containing degenerate bases
SELECT 'Testing DNA4 cache with degenerate bases...' as test_phase;
                 test_phase                  
---------------------------------------------
 Testing DNA4 cache with degenerate bases...
(1 row)

SELECT COUNT(*) FROM test_cache_dna4 WHERE sequence =% 'NNNNNNNN';
 count 
-------
     0
(1 row)

SELECT COUNT(*) FROM test_cache_dna4 WHERE sequence =% 'ATCGATCN';
 count 
-------
     2
(1 row)

SELECT COUNT(*) FROM test_cache_dna4 WHERE sequence =% 'NATCGATC';
 count 
-------
     2
(1 row)

SELECT 'DNA4 cache statistics:' as test_phase;
       test_phase       
------------------------
 DNA4 cache statistics:
(1 row)

SELECT * FROM kmersearch_actual_min_score_cache_stats();
 hits | misses | current_entries | max_entries 
------+--------+-----------------+-------------
   41 |      9 |               9 |        1000
(1 row)

-- Clean up
DROP TABLE IF EXISTS test_cache_dna2 CASCADE;
DROP TABLE IF EXISTS test_cache_dna4 CASCADE;
DROP EXTENSION pg_kmersearch CASCADE;
SET client_min_messages = NOTICE;
