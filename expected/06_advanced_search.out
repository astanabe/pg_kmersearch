CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Test advanced search functionality and configuration
-- This test covers different k-mer sizes and configuration options
-- Test with different k-mer sizes
SET kmersearch.kmer_size = 6;
-- Create a new index with k=6
CREATE TABLE test_k6_sequences (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA2
);
INSERT INTO test_k6_sequences (name, sequence) VALUES
    ('k6_test1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('k6_test2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA');
CREATE INDEX idx_k6_gin ON test_k6_sequences USING gin (sequence);
-- Test search with k=6
SELECT id, name FROM test_k6_sequences WHERE sequence =% 'ATCGATCG' ORDER BY id;
 id |   name   
----+----------
  1 | k6_test1
(1 row)

-- Test scoring with k=6
SELECT id, name,
       kmersearch_rawscore(sequence, 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA') AS rawscore
FROM test_k6_sequences ORDER BY id;
 id |   name   | rawscore 
----+----------+----------
  1 | k6_test1 |       56
  2 | k6_test2 |        0
(2 rows)

-- Test with k=6
SET kmersearch.kmer_size = 6;
CREATE TABLE test_k6_sequences_2 (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA2
);
INSERT INTO test_k6_sequences_2 (name, sequence) VALUES
    ('k6_test1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('k6_test2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA');
CREATE INDEX idx_k6_gin_2 ON test_k6_sequences_2 USING gin (sequence);
-- Test search with k=6
SELECT id, name FROM test_k6_sequences_2 WHERE sequence =% 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA' ORDER BY id;
 id |   name   
----+----------
  1 | k6_test1
(1 row)

-- Test complete search workflow with ORDER BY score
SELECT id, name, 
       kmersearch_rawscore(sequence, 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA') AS score
FROM test_k6_sequences_2 
WHERE sequence =% 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'
ORDER BY score DESC, id;
 id |   name   | score 
----+----------+-------
  1 | k6_test1 |    56
(1 row)

-- Reset k-mer size for other tests
SET kmersearch.kmer_size = 4;
DROP EXTENSION pg_kmersearch CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to column sequence of table test_k6_sequences
drop cascades to column sequence of table test_k6_sequences_2
