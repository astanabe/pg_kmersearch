CREATE EXTENSION pg_kmersearch;
-- Test k-mer search operators and functionality
-- This test covers the =% operator and search functionality
-- Clean up any existing tables
DROP TABLE IF EXISTS test_DNA2_sequences, test_DNA4_sequences CASCADE;
-- Create test tables for this test
CREATE TABLE test_DNA2_sequences (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA2
);
CREATE TABLE test_DNA4_sequences (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA4
);
-- Insert test data
INSERT INTO test_DNA2_sequences (name, sequence) VALUES
    ('seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('seq2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('seq3', 'ATCGATCGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT');
INSERT INTO test_DNA4_sequences (name, sequence) VALUES
    ('seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('seq2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('seq3', 'ATCGATCGNNATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATC');
-- Create GIN indexes
CREATE INDEX idx_DNA2_gin ON test_DNA2_sequences USING gin (sequence);
CREATE INDEX idx_DNA4_gin ON test_DNA4_sequences USING gin (sequence);
-- Test =% operator with DNA2
SELECT id, name FROM test_DNA2_sequences WHERE sequence =% 'ATCGATCG' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

SELECT id, name FROM test_DNA2_sequences WHERE sequence =% 'GCTAG' ORDER BY id;
ERROR:  Query sequence must be at least 8 bases long
SELECT id, name FROM test_DNA2_sequences WHERE sequence =% 'TTTTTTTT' ORDER BY id;
 id | name 
----+------
  3 | seq3
(1 row)

-- Test =% operator with DNA4
SELECT id, name FROM test_DNA4_sequences WHERE sequence =% 'ATCGATCG' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

SELECT id, name FROM test_DNA4_sequences WHERE sequence =% 'GCTAG' ORDER BY id;
ERROR:  Query sequence must be at least 8 bases long
SELECT id, name FROM test_DNA4_sequences WHERE sequence =% 'NNATCG' ORDER BY id;
ERROR:  Query sequence must be at least 8 bases long
-- Test query length validation (should work with 8+ characters)
SELECT id, name FROM test_DNA2_sequences WHERE sequence =% 'ATCGATCG' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

-- Test too short query (should error)
\set ON_ERROR_STOP off
SELECT id, name FROM test_DNA2_sequences WHERE sequence =% 'ATCG';
ERROR:  Query sequence must be at least 8 bases long
\set ON_ERROR_STOP on
-- Test case insensitivity in queries
SELECT id, name FROM test_DNA2_sequences WHERE sequence =% 'atcgatcg' ORDER BY id;
 id | name 
----+------
(0 rows)

SELECT id, name FROM test_DNA4_sequences WHERE sequence =% 'atcgatcg' ORDER BY id;
 id | name 
----+------
(0 rows)

DROP EXTENSION pg_kmersearch CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to column sequence of table test_dna2_sequences
drop cascades to column sequence of table test_dna4_sequences
