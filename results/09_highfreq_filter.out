CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Test high-frequency k-mer cache management functionality
-- This test covers manual cache loading and clearing
-- Clean up any existing tables
DROP TABLE IF EXISTS test_highfreq_dna2 CASCADE;
NOTICE:  table "test_highfreq_dna2" does not exist, skipping
-- Create test table for high-frequency k-mer analysis
CREATE TABLE test_highfreq_dna2 (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA2
);
-- Insert test data with 10 sequences of 100 bp each
INSERT INTO test_highfreq_dna2 (name, sequence) VALUES
    ('seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCG'),
    ('seq2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('seq3', 'TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT'),
    ('seq4', 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'),
    ('seq5', 'CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC'),
    ('seq6', 'GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGG'),
    ('seq7', 'ACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGT'),
    ('seq8', 'TGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCATGCA'),
    ('seq9', 'CAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGTTCAGT'),
    ('seq10', 'GTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTAC');
-- Create GIN index for high-frequency k-mer analysis
CREATE INDEX idx_test_highfreq_dna2_gin ON test_highfreq_dna2 USING gin (sequence);
-- Test kmersearch_analyze_table functionality
SELECT 'Testing kmersearch_analyze_table...' as test_phase;
             test_phase              
-------------------------------------
 Testing kmersearch_analyze_table...
(1 row)

-- Analyze the table to identify high-frequency k-mers
-- This will create entries in kmersearch_highfreq_kmer and kmersearch_highfreq_kmer_meta tables
WITH analysis_result AS (
    SELECT kmersearch_analyze_table(
        (SELECT oid FROM pg_class WHERE relname = 'test_highfreq_dna2'), 
        'sequence', 
        8, 
        2  -- parallel_workers (default 0)
    ) AS result
)
SELECT (result).* FROM analysis_result;
NOTICE:  Performing k-mer frequency analysis for k=8
NOTICE:  Max appearance rate: 0.050000, Max appearance nrow: 0
NOTICE:  Phase 1: Analyzing k-mer frequencies with 2 parallel workers...
NOTICE:  Phase 2: Collecting n-gram keys for high-frequency k-mers...
 total_rows | highfreq_kmers_count | parallel_workers_used | analysis_duration | max_appearance_rate_used | max_appearance_nrow_used 
------------+----------------------+-----------------------+-------------------+--------------------------+--------------------------
         10 |                   93 |                     2 |                 0 |                     0.05 |                        0
(1 row)

-- No need to manually insert data since analyze_table should handle it
-- Check if analysis created metadata
SELECT 'Checking analysis metadata...' as test_phase;
          test_phase           
-------------------------------
 Checking analysis metadata...
(1 row)

SELECT COUNT(*) as meta_count FROM kmersearch_highfreq_kmer_meta 
WHERE table_oid = (SELECT oid FROM pg_class WHERE relname = 'test_highfreq_dna2');
 meta_count 
------------
          1
(1 row)

-- Check if analysis created high-frequency k-mer data
SELECT 'Checking high-frequency k-mers...' as test_phase;
            test_phase             
-----------------------------------
 Checking high-frequency k-mers...
(1 row)

SELECT COUNT(*) as highfreq_kmer_count FROM kmersearch_highfreq_kmer
WHERE index_oid IN (
    SELECT indexrelid FROM pg_stat_user_indexes 
    WHERE schemaname = 'public' AND relname = 'test_highfreq_dna2'
);
 highfreq_kmer_count 
---------------------
                  93
(1 row)

-- Test high-frequency k-mer cache functions with analysis data
SELECT 'Testing cache loading with analysis data...' as test_phase;
                 test_phase                  
---------------------------------------------
 Testing cache loading with analysis data...
(1 row)

-- Test high-frequency k-mer cache loading
SELECT 'Testing cache loading...' as test_phase;
        test_phase        
--------------------------
 Testing cache loading...
(1 row)

-- Set GUC variables to match metadata
SET kmersearch.max_appearance_rate = 0.05;
SET kmersearch.max_appearance_nrow = 0;
SELECT kmersearch_highfreq_kmers_cache_load(test_highfreq_dna2.tableoid, 'sequence', 8) as cache_loaded
FROM test_highfreq_dna2 LIMIT 1;
 cache_loaded 
--------------
 t
(1 row)

-- Test high-frequency k-mer cache clearing
SELECT 'Testing cache clearing...' as test_phase;
        test_phase         
---------------------------
 Testing cache clearing...
(1 row)

SELECT kmersearch_highfreq_kmers_cache_free() as freed_entries;
 freed_entries 
---------------
            93
(1 row)

-- Test cache loading with non-existent data
SELECT 'Testing cache loading with invalid parameters...' as test_phase;
                    test_phase                    
--------------------------------------------------
 Testing cache loading with invalid parameters...
(1 row)

SELECT kmersearch_highfreq_kmers_cache_load(0, 'nonexistent', 8) as cache_loaded;
ERROR:  No metadata found for table_oid=0, column_name='nonexistent', k_value=8
HINT:  Run kmersearch_analyze_table() first to create metadata.
-- Test cache clearing when no cache exists
SELECT 'Testing cache clearing when no cache exists...' as test_phase;
                   test_phase                   
------------------------------------------------
 Testing cache clearing when no cache exists...
(1 row)

SELECT kmersearch_highfreq_kmers_cache_free() as freed_entries;
 freed_entries 
---------------
             0
(1 row)

-- Test GUC validation and cache hierarchy
SELECT 'Testing GUC validation and cache hierarchy...' as test_phase;
                  test_phase                   
-----------------------------------------------
 Testing GUC validation and cache hierarchy...
(1 row)

-- Reset GUC settings to match metadata for testing
SET kmersearch.max_appearance_rate = 0.05;
SET kmersearch.max_appearance_nrow = 0;
SET kmersearch.occur_bitlen = 8;
-- Insert some test high-frequency k-mer data for cache hierarchy testing
INSERT INTO kmersearch_highfreq_kmer (index_oid, ngram_key, detection_reason)
VALUES (
  (SELECT indexrelid FROM pg_stat_user_indexes WHERE relname = 'test_highfreq_dna2' AND indexrelname = 'idx_test_highfreq_dna2_gin'),
  '01010101'::bit(16),  -- Sample n-gram key  
  'regression_test'
);
-- Test 1: GUC validation error handling
SELECT 'Testing GUC validation errors...' as test_substep;
           test_substep           
----------------------------------
 Testing GUC validation errors...
(1 row)

-- Change GUC to cause mismatch and test cache loading (should fail)
SET kmersearch.max_appearance_rate = 0.9;  -- Different from metadata (0.05)
SELECT kmersearch_highfreq_kmers_cache_load(
  (SELECT oid FROM pg_class WHERE relname = 'test_highfreq_dna2'),
  'sequence', 8
) as cache_load_with_mismatch;
ERROR:  GUC validation failed: kmersearch.max_appearance_rate mismatch
DETAIL:  Current setting: 0.9000, Required by metadata: 0.0500
HINT:  Set kmersearch.max_appearance_rate = 0.0500 before loading cache.
-- Reset to correct values
SET kmersearch.max_appearance_rate = 0.05;
-- Test 2: Cache hierarchy - Global cache
SELECT 'Testing global cache hierarchy...' as test_substep;
           test_substep            
-----------------------------------
 Testing global cache hierarchy...
(1 row)

SELECT kmersearch_highfreq_kmers_cache_load(
  (SELECT oid FROM pg_class WHERE relname = 'test_highfreq_dna2'),
  'sequence', 8
) as global_cache_loaded;
 global_cache_loaded 
---------------------
 t
(1 row)

-- Test query with global cache
SELECT sequence =% 'ATCGATCG' as global_cache_query FROM test_highfreq_dna2 LIMIT 1;
 global_cache_query 
--------------------
 t
(1 row)

-- Test 3: Cache hierarchy - Parallel cache  
SELECT 'Testing parallel cache hierarchy...' as test_substep;
            test_substep             
-------------------------------------
 Testing parallel cache hierarchy...
(1 row)

SELECT kmersearch_parallel_highfreq_kmers_cache_load(
  (SELECT oid FROM pg_class WHERE relname = 'test_highfreq_dna2'),
  'sequence', 8
) as parallel_cache_loaded;
 parallel_cache_loaded 
-----------------------
 t
(1 row)

-- Test 4: Cache hierarchy fallback
SELECT 'Testing cache hierarchy fallback...' as test_substep;
            test_substep             
-------------------------------------
 Testing cache hierarchy fallback...
(1 row)

-- Clear global cache
SELECT kmersearch_highfreq_kmers_cache_free() as global_freed;
 global_freed 
--------------
           94
(1 row)

-- Test with only parallel cache
SET kmersearch.force_use_dshash = true;
SELECT sequence =% 'ATCGATCG' as parallel_only_query FROM test_highfreq_dna2 LIMIT 1;
 parallel_only_query 
---------------------
 t
(1 row)

-- Clear parallel cache  
SELECT kmersearch_parallel_highfreq_kmers_cache_free() as parallel_freed;
 parallel_freed 
----------------
             94
(1 row)

-- Test with no cache (table lookup fallback)
SET kmersearch.force_use_dshash = false;
SELECT sequence =% 'ATCGATCG' as table_fallback_query FROM test_highfreq_dna2 LIMIT 1;
 table_fallback_query 
----------------------
 t
(1 row)

-- Clean up test data
DELETE FROM kmersearch_highfreq_kmer WHERE detection_reason = 'regression_test';
-- Clean up analysis data
SELECT 'Cleaning up analysis data...' as test_phase;
          test_phase          
------------------------------
 Cleaning up analysis data...
(1 row)

DELETE FROM kmersearch_highfreq_kmer
WHERE index_oid IN (
    SELECT indexrelid FROM pg_stat_user_indexes 
    WHERE schemaname = 'public' AND relname = 'test_highfreq_dna2'
);
DELETE FROM kmersearch_highfreq_kmer_meta 
WHERE table_oid = (SELECT oid FROM pg_class WHERE relname = 'test_highfreq_dna2');
-- Clean up
DROP TABLE test_highfreq_dna2 CASCADE;
DROP EXTENSION pg_kmersearch CASCADE;
