SET client_min_messages = WARNING;
-- Limit parallel workers to 2 for consistent test results
SET max_parallel_maintenance_workers = 2;
CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Test comprehensive cache hierarchy and GUC validation functionality
-- This test covers the enhanced kmersearch_is_kmer_highfreq implementation
-- Set GUC variables for index creation (will be changed later for testing)
SET kmersearch.kmer_size = 4;
SET kmersearch.occur_bitlen = 8;
SET kmersearch.max_appearance_rate = 0.2;
SET kmersearch.max_appearance_nrow = 3;
-- Clean up any existing test data
DROP TABLE IF EXISTS test_cache_hierarchy CASCADE;
DELETE FROM kmersearch_highfreq_kmer WHERE detection_reason LIKE 'cache_hierarchy_%';
DELETE FROM kmersearch_highfreq_kmer_meta WHERE column_name = 'test_seq';
-- Create test table for cache hierarchy testing
CREATE TABLE test_cache_hierarchy (
    id SERIAL PRIMARY KEY,
    test_seq dna2
);
-- Insert test data with repeated patterns to ensure high-frequency k-mers
INSERT INTO test_cache_hierarchy (test_seq) VALUES 
    ('ATCGATCGATCGATCGATCGATCGATCGATCG'::dna2),
    ('ATCGATCGATCGATCGATCGATCGATCGATCG'::dna2),
    ('ATCGATCGATCGATCGATCGATCGATCGATCG'::dna2),
    ('ATCGATCGATCGATCGATCGATCGATCGATCG'::dna2),
    ('ATCGATCGATCGATCGATCGATCGATCGATCG'::dna2),
    ('GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCT'::dna2),
    ('GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCT'::dna2),
    ('GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCT'::dna2),
    ('GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCT'::dna2),
    ('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'::dna2),
    ('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'::dna2),
    ('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'::dna2),
    ('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'::dna2);
-- Create GIN index (using kmer_size=4)
-- With k=4 and occur_bitlen=8, total bits = 4*2+8 = 16, so we can use int2 operator class
CREATE INDEX test_cache_hierarchy_gin_idx ON test_cache_hierarchy USING gin (test_seq kmersearch_dna2_gin_ops_int2);
-- Test Phase 1: No metadata scenario (should work with table fallback)
SELECT 'Phase 1: Testing without metadata table...' as test_phase;
                 test_phase                 
--------------------------------------------
 Phase 1: Testing without metadata table...
(1 row)

SELECT test_seq =% 'ATCGATCG' as no_metadata_query FROM test_cache_hierarchy LIMIT 1;
 no_metadata_query 
-------------------
 t
(1 row)

-- Test Phase 2: Perform high-frequency k-mer analysis
SELECT 'Phase 2: Performing high-frequency k-mer analysis...' as test_phase;
                      test_phase                      
------------------------------------------------------
 Phase 2: Performing high-frequency k-mer analysis...
(1 row)

-- Perform actual high-frequency k-mer analysis
SELECT kmersearch_perform_highfreq_analysis(
    'test_cache_hierarchy'::text,
    'test_seq'::text
) AS analysis_result;
INFO:  Starting high-frequency k-mer analysis: 13 rows in 1 blocks with 2 parallel workers
INFO:  Batch 1 completed: 13 / 13 rows processed of column test_seq in table test_cache_hierarchy (final)
INFO:  Parallel scan completed. Starting aggregation of results.
INFO:  Starting parallel aggregation of 2 temporary files
INFO:  Merge stage 1: 2 files, 1 parallel workers
INFO:  Merge completed after 1 stages
INFO:  Writing 86 high-frequency k-mers to kmersearch_highfreq_kmer table...
INFO:  Successfully wrote 86 high-frequency k-mers to database.
 analysis_result 
-----------------
 (13,86,2,0.2,2)
(1 row)

-- Verify analysis results
SELECT 'Verifying analysis results:' AS status;
           status            
-----------------------------
 Verifying analysis results:
(1 row)

SELECT highfreq_kmer_count, max_appearance_rate, max_appearance_nrow 
FROM kmersearch_analysis_status 
WHERE table_name = 'test_cache_hierarchy' AND column_name = 'test_seq';
 highfreq_kmer_count | max_appearance_rate | max_appearance_nrow 
---------------------+---------------------+---------------------
                  86 |                 0.2 |                   3
(1 row)

-- Test 2.1: Matching GUC settings (should work)
SET kmersearch.kmer_size = 4;
SET kmersearch.occur_bitlen = 8;
SET kmersearch.max_appearance_rate = 0.2;
SET kmersearch.max_appearance_nrow = 3;
SET kmersearch.min_shared_kmer_rate = 0.2;  -- Allow matches with 20% shared k-mers
SELECT test_seq =% 'ATCGATCG' as matching_guc_query FROM test_cache_hierarchy LIMIT 1;
 matching_guc_query 
--------------------
 t
(1 row)

-- Test 2.2: Mismatched GUC - occur_bitlen (should fail during cache load)
SET kmersearch.occur_bitlen = 16;
SELECT kmersearch_highfreq_kmer_cache_load(
  'test_cache_hierarchy',
  'test_seq'
) as mismatched_occur_bitlen;
ERROR:  GUC validation failed: kmersearch.occur_bitlen mismatch
DETAIL:  Current setting: 16, Required by metadata: 8
HINT:  Set kmersearch.occur_bitlen = 8 before loading cache.
-- Test 2.3: Mismatched GUC - max_appearance_rate (should fail during cache load)
SET kmersearch.kmer_size = 4;  -- Reset
SET kmersearch.occur_bitlen = 8;  -- Reset
SET kmersearch.max_appearance_rate = 0.8;
SELECT kmersearch_highfreq_kmer_cache_load(
  'test_cache_hierarchy',
  'test_seq'
) as mismatched_rate;
ERROR:  GUC validation failed: kmersearch.max_appearance_rate mismatch
DETAIL:  Current setting: 0.8000, Required by metadata: 0.2000
HINT:  Set kmersearch.max_appearance_rate = 0.2000 before loading cache.
-- Test 2.4: Mismatched GUC - max_appearance_nrow (should fail during cache load)
SET kmersearch.kmer_size = 4;  -- Reset
SET kmersearch.max_appearance_rate = 0.4;  -- Reset
SET kmersearch.max_appearance_nrow = 10;
SELECT kmersearch_highfreq_kmer_cache_load(
  'test_cache_hierarchy',
  'test_seq'
) as mismatched_nrow;
ERROR:  GUC validation failed: kmersearch.max_appearance_rate mismatch
DETAIL:  Current setting: 0.4000, Required by metadata: 0.2000
HINT:  Set kmersearch.max_appearance_rate = 0.2000 before loading cache.
-- Reset to correct values for subsequent tests
SET kmersearch.kmer_size = 4;
SET kmersearch.max_appearance_nrow = 1;
SET kmersearch.occur_bitlen = 8;
SET kmersearch.max_appearance_rate = 0.01;
-- Test Phase 3: Cache hierarchy testing
SELECT 'Phase 3: Testing cache hierarchy...' as test_phase;
             test_phase              
-------------------------------------
 Phase 3: Testing cache hierarchy...
(1 row)

-- High-frequency k-mer data should already exist from the analysis above
-- Test 3.1: Global cache loading and usage
SELECT 'Testing global cache...' as test_substep;
      test_substep       
-------------------------
 Testing global cache...
(1 row)

SELECT kmersearch_highfreq_kmer_cache_load(
  'test_cache_hierarchy',
  'test_seq'
) as global_cache_load_result;
ERROR:  GUC validation failed: kmersearch.max_appearance_rate mismatch
DETAIL:  Current setting: 0.0100, Required by metadata: 0.2000
HINT:  Set kmersearch.max_appearance_rate = 0.2000 before loading cache.
-- Query with global cache loaded
SELECT test_seq =% 'ATCGATCG' as global_cache_query FROM test_cache_hierarchy LIMIT 1;
 global_cache_query 
--------------------
 t
(1 row)

-- Test 3.2: Parallel cache loading and usage
SELECT 'Testing parallel cache...' as test_substep;
       test_substep        
---------------------------
 Testing parallel cache...
(1 row)

SELECT kmersearch_parallel_highfreq_kmer_cache_load(
  'test_cache_hierarchy',
  'test_seq'
) as parallel_cache_load_result;
ERROR:  GUC validation failed: kmersearch.max_appearance_rate mismatch
DETAIL:  Current setting: 0.0100, Required by metadata: 0.2000
HINT:  Set kmersearch.max_appearance_rate = 0.2000 before loading cache.
-- Test 3.3: Cache hierarchy fallback sequence
SELECT 'Testing cache hierarchy fallback...' as test_substep;
            test_substep             
-------------------------------------
 Testing cache hierarchy fallback...
(1 row)

-- Clear global cache first
SELECT kmersearch_highfreq_kmer_cache_free_all() as global_cache_cleared;
 global_cache_cleared 
----------------------
                    0
(1 row)

-- Test with parallel cache only (should work)
SET kmersearch.force_use_parallel_highfreq_kmer_cache = true;
SELECT test_seq =% 'ATCGATCG' as parallel_only_query FROM test_cache_hierarchy LIMIT 1;
 parallel_only_query 
---------------------
 t
(1 row)

-- Clear parallel cache too
SELECT kmersearch_parallel_highfreq_kmer_cache_free_all() as parallel_cache_cleared;
 parallel_cache_cleared 
------------------------
                      0
(1 row)

-- Test with no cache (should fall back to table lookup)
SET kmersearch.force_use_parallel_highfreq_kmer_cache = false;
SELECT test_seq =% 'ATCGATCG' as table_fallback_query FROM test_cache_hierarchy LIMIT 1;
 table_fallback_query 
----------------------
 t
(1 row)

-- Test Phase 4: Table lookup without high-frequency data
SELECT 'Phase 4: Testing table lookup without high-frequency data...' as test_phase;
                          test_phase                          
--------------------------------------------------------------
 Phase 4: Testing table lookup without high-frequency data...
(1 row)

-- Remove all high-frequency k-mer data
DELETE FROM kmersearch_highfreq_kmer WHERE table_oid = (SELECT oid FROM pg_class WHERE relname = 'test_cache_hierarchy') AND column_name = 'test_seq';
-- Test query (should work but find no high-frequency k-mers)
SELECT test_seq =% 'ATCGATCG' as no_highfreq_data_query FROM test_cache_hierarchy LIMIT 1;
 no_highfreq_data_query 
------------------------
 t
(1 row)

-- Test Phase 5: Non-existent table scenario
SELECT 'Phase 5: Testing non-existent table scenario...' as test_phase;
                   test_phase                    
-------------------------------------------------
 Phase 5: Testing non-existent table scenario...
(1 row)

-- Remove metadata to simulate non-existent table scenario
DELETE FROM kmersearch_highfreq_kmer_meta WHERE column_name = 'test_seq';
-- Test query (should work with no validation)
SELECT test_seq =% 'ATCGATCG' as no_table_query FROM test_cache_hierarchy LIMIT 1;
 no_table_query 
----------------
 t
(1 row)

-- Clean up test data
SELECT 'Cleaning up test data...' as cleanup_phase;
      cleanup_phase       
--------------------------
 Cleaning up test data...
(1 row)

DROP TABLE IF EXISTS test_cache_hierarchy CASCADE;
DELETE FROM kmersearch_highfreq_kmer WHERE table_oid = (SELECT oid FROM pg_class WHERE relname = 'test_cache_hierarchy') AND column_name = 'test_seq';
DELETE FROM kmersearch_highfreq_kmer_meta WHERE column_name = 'test_seq';
SELECT 'Cache hierarchy test completed successfully!' as final_result;
                 final_result                 
----------------------------------------------
 Cache hierarchy test completed successfully!
(1 row)

DROP EXTENSION pg_kmersearch CASCADE;
SET client_min_messages = NOTICE;
