SET client_min_messages = WARNING;
CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- High-frequency k-mer exclusion functionality comprehensive test
-- kmersearch.kmer_size=4, kmersearch.occur_bitlen=4, kmersearch.max_appearance_rate=0.25,
-- kmersearch.max_appearance_nrow=0, kmersearch.min_score=1, kmersearch.min_shared_ngram_key_rate=0.9,
-- kmersearch.preclude_highfreq_kmer=true, kmersearch.force_use_parallel_highfreq_kmer_cache=false
-- Apply specified GUC settings
SET kmersearch.kmer_size = 4;
SET kmersearch.occur_bitlen = 4;
SET kmersearch.max_appearance_rate = 0.25;
SET kmersearch.max_appearance_nrow = 0;
SET kmersearch.min_score = 1;
SET kmersearch.min_shared_ngram_key_rate = 0.9;
SET kmersearch.preclude_highfreq_kmer = true;
SET kmersearch.force_use_parallel_highfreq_kmer_cache = false;
-- Configuration verification
SELECT 'GUC settings verification:' as info;
            info            
----------------------------
 GUC settings verification:
(1 row)

SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 4
(1 row)

SHOW kmersearch.max_appearance_rate;
 kmersearch.max_appearance_rate 
--------------------------------
 0.25
(1 row)

SHOW kmersearch.preclude_highfreq_kmer;
 kmersearch.preclude_highfreq_kmer 
-----------------------------------
 on
(1 row)

-- Create test table
DROP TABLE IF EXISTS test_dna_highfreq CASCADE;
CREATE TABLE test_dna_highfreq (
    id SERIAL PRIMARY KEY,
    seq DNA2
);
-- Insert test data containing high-frequency k-mers for k=4
INSERT INTO test_dna_highfreq (seq) VALUES 
    ('AAAACTGTACGT'::DNA2),    -- Contains AAAA, AAAa, AACa, ACTa
    ('AAAAGCATGCAT'::DNA2),    -- Contains AAAA, AAAa, AAGa, AGCa  
    ('AAAATCGATCGA'::DNA2),    -- Contains AAAA, AAAa, AATa, ATCa
    ('AAAACCCCGGGG'::DNA2),    -- Contains AAAA, AAAa, AACc, CCCC
    ('AAAATTTTAAAA'::DNA2),    -- Contains AAAA, AAAa, AATt, TTTT
    ('TCGTAAAACGTA'::DNA2),    -- Contains AAAA
    ('GCATAAAATCGA'::DNA2),    -- Contains AAAA
    ('ATCGAAAACCCC'::DNA2),    -- Contains AAAA, CCCC
    ('CCCCAAAATTTT'::DNA2),    -- Contains CCCC, AAAA, TTTT
    ('TTTTAAAACCCC'::DNA2),    -- Contains TTTT, AAAA, CCCC
    ('CCCCCCCCCCCC'::DNA2),    -- Contains many CCCC
    ('TTTTTTTTTTTT'::DNA2),    -- Contains many TTTT
    ('ACGTACGTACGT'::DNA2),    -- Different pattern
    ('TGCATGCATGCA'::DNA2);    -- Different pattern
SELECT 'Test data creation completed:' as info, COUNT(*) as total_rows FROM test_dna_highfreq;
             info              | total_rows 
-------------------------------+------------
 Test data creation completed: |         14
(1 row)

-- 1. Execute kmersearch_perform_highfreq_analysis()
SELECT '1. High-frequency k-mer analysis execution:' as step;
                    step                     
---------------------------------------------
 1. High-frequency k-mer analysis execution:
(1 row)

SELECT kmersearch_perform_highfreq_analysis('test_dna_highfreq', 'seq');
 kmersearch_perform_highfreq_analysis 
--------------------------------------
 (14,6,2,0,0.25,3)
(1 row)

-- 2. Execute kmersearch_highfreq_kmer_cache_load()
SELECT '2. High-frequency k-mer cache load:' as step;
                step                 
-------------------------------------
 2. High-frequency k-mer cache load:
(1 row)

SELECT kmersearch_highfreq_kmer_cache_load('test_dna_highfreq', 'seq');
 kmersearch_highfreq_kmer_cache_load 
-------------------------------------
 t
(1 row)

-- 3. CREATE INDEX (high-frequency ngram_key2 are excluded from GIN index)
SELECT '3. GIN index creation:' as step;
          step          
------------------------
 3. GIN index creation:
(1 row)

CREATE INDEX idx_test_dna_highfreq_seq ON test_dna_highfreq USING gin (seq);
-- Index creation verification
SELECT '   Index creation verification:' as info;
              info               
---------------------------------
    Index creation verification:
(1 row)

SELECT schemaname, tablename, indexname 
FROM pg_indexes 
WHERE tablename = 'test_dna_highfreq' AND indexname = 'idx_test_dna_highfreq_seq';
 schemaname |     tablename     |         indexname         
------------+-------------------+---------------------------
 public     | test_dna_highfreq | idx_test_dna_highfreq_seq
(1 row)

-- 4. GIN index-based search
SELECT '4. GIN index-based search:' as step;
            step            
----------------------------
 4. GIN index-based search:
(1 row)

SELECT id, seq, kmersearch_rawscore_dna2(seq, 'AAAACTGT') as rawscore
FROM test_dna_highfreq 
WHERE seq =% 'AAAACTGT'
ORDER BY rawscore DESC, id;
 id |     seq      | rawscore 
----+--------------+----------
  1 | AAAACTGTACGT |        5
(1 row)

-- 5. Execute kmersearch_highfreq_kmer_cache_free()
SELECT '5. High-frequency k-mer cache release:' as step;
                  step                  
----------------------------------------
 5. High-frequency k-mer cache release:
(1 row)

SELECT kmersearch_highfreq_kmer_cache_free('test_dna_highfreq', 'seq');
 kmersearch_highfreq_kmer_cache_free 
-------------------------------------
                                   6
(1 row)

-- 6. GIN index-based search after cache release
SELECT '6. GIN index search after cache release:' as step;
                   step                   
------------------------------------------
 6. GIN index search after cache release:
(1 row)

SELECT id, seq, kmersearch_rawscore_dna2(seq, 'AAAACTGT') as rawscore
FROM test_dna_highfreq 
WHERE seq =% 'AAAACTGT'
ORDER BY rawscore DESC, id;
 id |     seq      | rawscore 
----+--------------+----------
  1 | AAAACTGTACGT |        5
(1 row)

-- Additional test: High-frequency k-mer exclusion effect verification
SELECT '7. High-frequency k-mer exclusion effect verification:' as step;
                          step                          
--------------------------------------------------------
 7. High-frequency k-mer exclusion effect verification:
(1 row)

-- High-frequency k-mer status verification
SELECT 'System table content verification:' as info;
                info                
------------------------------------
 System table content verification:
(1 row)

SELECT COUNT(*) as highfreq_kmer_count 
FROM kmersearch_highfreq_kmer 
WHERE table_oid = (SELECT oid FROM pg_class WHERE relname = 'test_dna_highfreq');
 highfreq_kmer_count 
---------------------
                   6
(1 row)

-- Multiple queries search result verification
SELECT 'Multiple queries search results:' as info;
               info               
----------------------------------
 Multiple queries search results:
(1 row)

SELECT 'AAAACTGT' as query, COUNT(*) as match_count 
FROM test_dna_highfreq 
WHERE seq =% 'AAAACTGT';
  query   | match_count 
----------+-------------
 AAAACTGT |           1
(1 row)

SELECT 'CCCCTTTT' as query, COUNT(*) as match_count 
FROM test_dna_highfreq 
WHERE seq =% 'CCCCTTTT';
  query   | match_count 
----------+-------------
 CCCCTTTT |           0
(1 row)

-- Test completion message
SELECT 'High-frequency k-mer exclusion functionality test completed' as test_result;
                         test_result                         
-------------------------------------------------------------
 High-frequency k-mer exclusion functionality test completed
(1 row)

-- Cleanup
DROP TABLE test_dna_highfreq CASCADE;
DROP EXTENSION pg_kmersearch CASCADE;
SET client_min_messages = NOTICE;
