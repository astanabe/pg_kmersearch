SET client_min_messages = WARNING;
CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Set consistent GUC variables for this test
SET kmersearch.kmer_size = 16;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 16
(1 row)

SET kmersearch.occur_bitlen = 8;
SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 8
(1 row)

SET kmersearch.max_appearance_rate = 0.5;
SHOW kmersearch.max_appearance_rate;
 kmersearch.max_appearance_rate 
--------------------------------
 0.5
(1 row)

SET kmersearch.max_appearance_nrow = 0;
SHOW kmersearch.max_appearance_nrow;
 kmersearch.max_appearance_nrow 
--------------------------------
 0
(1 row)

-- Test table creation and GIN index functionality
-- This test covers DDL operations and index creation
-- Create test tables
CREATE TABLE test_dna2_sequences (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA2
);
CREATE TABLE test_dna4_sequences (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA4
);
-- Insert test data
INSERT INTO test_dna2_sequences (name, sequence) VALUES
    ('seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('seq2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('seq3', 'ATCGATCGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT');
INSERT INTO test_dna4_sequences (name, sequence) VALUES
    ('seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('seq2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('seq3', 'ATCGATCGNNATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATC');
-- Test data retrieval
SELECT id, name, sequence FROM test_dna2_sequences ORDER BY id;
 id | name |                           sequence                            
----+------+---------------------------------------------------------------
  1 | seq1 | ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA
  2 | seq2 | GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA
  3 | seq3 | ATCGATCGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT
(3 rows)

SELECT id, name, sequence FROM test_dna4_sequences ORDER BY id;
 id | name |                           sequence                            
----+------+---------------------------------------------------------------
  1 | seq1 | ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA
  2 | seq2 | GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA
  3 | seq3 | ATCGATCGNNATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATC
(3 rows)

-- Create GIN indexes
-- With k=16 and occur_bitlen=8, total bits = 16*2+8 = 40, so we need int8 operator class
CREATE INDEX idx_dna2_gin ON test_dna2_sequences USING gin (sequence kmersearch_dna2_gin_ops_int8);
CREATE INDEX idx_dna4_gin ON test_dna4_sequences USING gin (sequence kmersearch_dna4_gin_ops_int8);
-- Verify indexes exist
SELECT indexname, tablename FROM pg_indexes
WHERE indexname IN ('idx_dna2_gin', 'idx_dna4_gin')
ORDER BY indexname;
  indexname   |      tablename      
--------------+---------------------
 idx_dna2_gin | test_dna2_sequences
 idx_dna4_gin | test_dna4_sequences
(2 rows)

-- Verify index settings are saved in kmersearch_index_info by event trigger
SELECT
    i.index_oid IS NOT NULL as has_index_oid,
    i.kmer_size,
    i.occur_bitlen,
    i.max_appearance_rate,
    i.max_appearance_nrow,
    i.preclude_highfreq_kmer
FROM kmersearch_index_info i
JOIN pg_class c ON c.oid = i.index_oid
WHERE c.relname = 'idx_dna2_gin';
 has_index_oid | kmer_size | occur_bitlen | max_appearance_rate | max_appearance_nrow | preclude_highfreq_kmer 
---------------+-----------+--------------+---------------------+---------------------+------------------------
 t             |        16 |            8 |                 0.5 |                   0 | f
(1 row)

-- Clean up test tables
DROP TABLE IF EXISTS test_dna2_sequences CASCADE;
DROP TABLE IF EXISTS test_dna4_sequences CASCADE;
-- Verify DROP INDEX event trigger cleans up metadata
SELECT COUNT(*) as remaining_entries FROM kmersearch_index_info
WHERE index_oid NOT IN (SELECT oid FROM pg_class WHERE relkind = 'i');
 remaining_entries 
-------------------
                 0
(1 row)

-- Test multiple indexes with different settings and automatic index selection
CREATE TABLE test_index_select (
    id SERIAL PRIMARY KEY,
    sequence DNA2
);
-- Insert sufficient test data for index usage
INSERT INTO test_index_select (sequence)
SELECT 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCG'::DNA2
FROM generate_series(1, 100);
-- Create first index with kmer_size=7, occur_bitlen=2 (7*2+2=16 bits -> int2)
SET kmersearch.kmer_size = 7;
SET kmersearch.occur_bitlen = 2;
SET kmersearch.max_appearance_rate = 0.5;
SET kmersearch.max_appearance_nrow = 0;
SET kmersearch.preclude_highfreq_kmer = false;
CREATE INDEX idx_k7 ON test_index_select USING gin (sequence kmersearch_dna2_gin_ops_int2);
-- Verify settings saved for idx_k7
SELECT kmer_size, occur_bitlen, preclude_highfreq_kmer
FROM kmersearch_index_info i
JOIN pg_class c ON c.oid = i.index_oid
WHERE c.relname = 'idx_k7';
 kmer_size | occur_bitlen | preclude_highfreq_kmer 
-----------+--------------+------------------------
         7 |            2 | f
(1 row)

-- Create second index with kmer_size=12, occur_bitlen=4 (12*2+4=28 bits -> int4)
SET kmersearch.kmer_size = 12;
SET kmersearch.occur_bitlen = 4;
CREATE INDEX idx_k12 ON test_index_select USING gin (sequence kmersearch_dna2_gin_ops_int4);
-- Verify settings saved for idx_k12
SELECT kmer_size, occur_bitlen, preclude_highfreq_kmer
FROM kmersearch_index_info i
JOIN pg_class c ON c.oid = i.index_oid
WHERE c.relname = 'idx_k12';
 kmer_size | occur_bitlen | preclude_highfreq_kmer 
-----------+--------------+------------------------
        12 |            4 | f
(1 row)

-- Test index selection: with kmer_size=7 settings, idx_k7 should be selected
SET kmersearch.kmer_size = 7;
SET kmersearch.occur_bitlen = 2;
EXPLAIN (COSTS OFF) SELECT * FROM test_index_select WHERE sequence =% 'ATCGATCGATCGATCGATCGATCGATCG';
                               QUERY PLAN                               
------------------------------------------------------------------------
 Bitmap Heap Scan on test_index_select
   Recheck Cond: (sequence =% 'ATCGATCGATCGATCGATCGATCGATCG'::text)
   ->  Bitmap Index Scan on idx_k7
         Index Cond: (sequence =% 'ATCGATCGATCGATCGATCGATCGATCG'::text)
(4 rows)

-- Test index selection: with kmer_size=12 settings, idx_k12 should be selected
SET kmersearch.kmer_size = 12;
SET kmersearch.occur_bitlen = 4;
EXPLAIN (COSTS OFF) SELECT * FROM test_index_select WHERE sequence =% 'ATCGATCGATCGATCGATCGATCGATCG';
                               QUERY PLAN                               
------------------------------------------------------------------------
 Bitmap Heap Scan on test_index_select
   Recheck Cond: (sequence =% 'ATCGATCGATCGATCGATCGATCGATCG'::text)
   ->  Bitmap Index Scan on idx_k12
         Index Cond: (sequence =% 'ATCGATCGATCGATCGATCGATCGATCG'::text)
(4 rows)

-- Clean up
DROP TABLE IF EXISTS test_index_select CASCADE;
-- Verify metadata cleanup after DROP TABLE CASCADE
SELECT COUNT(*) as remaining_after_drop FROM kmersearch_index_info
WHERE index_oid NOT IN (SELECT oid FROM pg_class WHERE relkind = 'i');
 remaining_after_drop 
----------------------
                    0
(1 row)

DROP EXTENSION pg_kmersearch CASCADE;
SET client_min_messages = NOTICE;
