SET client_min_messages = WARNING;
CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Test GUC configuration variables
-- This test covers all configuration parameters
-- Show default values
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 16
(1 row)

SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 8
(1 row)

SHOW kmersearch.max_appearance_rate;
 kmersearch.max_appearance_rate 
--------------------------------
 0.5
(1 row)

SHOW kmersearch.max_appearance_nrow;
 kmersearch.max_appearance_nrow 
--------------------------------
 0
(1 row)

SHOW kmersearch.min_score;
 kmersearch.min_score 
----------------------
 1
(1 row)

SHOW kmersearch.min_shared_ngram_key_rate;
 kmersearch.min_shared_ngram_key_rate 
--------------------------------------
 0.9
(1 row)

SHOW kmersearch.query_pattern_cache_max_entries;
 kmersearch.query_pattern_cache_max_entries 
--------------------------------------------
 50000
(1 row)

-- Test setting valid values
SET kmersearch.kmer_size = 6;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 6
(1 row)

SET kmersearch.occur_bitlen = 10;
SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 10
(1 row)

SET kmersearch.max_appearance_rate = 0.1;
SHOW kmersearch.max_appearance_rate;
 kmersearch.max_appearance_rate 
--------------------------------
 0.1
(1 row)

SET kmersearch.max_appearance_nrow = 1000;
SHOW kmersearch.max_appearance_nrow;
 kmersearch.max_appearance_nrow 
--------------------------------
 1000
(1 row)

SET kmersearch.min_score = 5;
SHOW kmersearch.min_score;
 kmersearch.min_score 
----------------------
 5
(1 row)

SET kmersearch.min_shared_ngram_key_rate = 0.8;
SHOW kmersearch.min_shared_ngram_key_rate;
 kmersearch.min_shared_ngram_key_rate 
--------------------------------------
 0.8
(1 row)

SET kmersearch.query_pattern_cache_max_entries = 25000;
SHOW kmersearch.query_pattern_cache_max_entries;
 kmersearch.query_pattern_cache_max_entries 
--------------------------------------------
 25000
(1 row)

-- Test boundary values
SET kmersearch.kmer_size = 4;  -- minimum
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 4
(1 row)

-- Test maximum k-mer size with occur_bitlen=10 (should error: 32*2+10=74 > 64)
\set ON_ERROR_STOP off
SET kmersearch.kmer_size = 32; -- should fail with occur_bitlen=10
ERROR:  invalid kmersearch.kmer_size value
DETAIL:  Total bit length (kmer_size * 2 + occur_bitlen) = (32 * 2 + 10) = 74 exceeds maximum of 64 bits.
HINT:  Reduce kmer_size or occur_bitlen so that (kmer_size * 2 + occur_bitlen) <= 64.
\set ON_ERROR_STOP on
SHOW kmersearch.kmer_size; -- should still be 4
 kmersearch.kmer_size 
----------------------
 4
(1 row)

-- Test maximum k-mer size with occur_bitlen=0 (should succeed: 32*2+0=64)
SET kmersearch.occur_bitlen = 0;
SET kmersearch.kmer_size = 32; -- should succeed now
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 32
(1 row)

-- Reset occur_bitlen (should fail because kmer_size is now 32)
\set ON_ERROR_STOP off
SET kmersearch.occur_bitlen = 10;
ERROR:  invalid kmersearch.occur_bitlen value
DETAIL:  Total bit length (kmer_size * 2 + occur_bitlen) = (32 * 2 + 10) = 74 exceeds maximum of 64 bits.
HINT:  Reduce occur_bitlen or kmer_size so that (kmer_size * 2 + occur_bitlen) <= 64.
\set ON_ERROR_STOP on
SET kmersearch.occur_bitlen = 0;  -- minimum
SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 0
(1 row)

\set ON_ERROR_STOP off
SET kmersearch.occur_bitlen = 16; -- maximum (should fail with kmer_size=32)
ERROR:  invalid kmersearch.occur_bitlen value
DETAIL:  Total bit length (kmer_size * 2 + occur_bitlen) = (32 * 2 + 16) = 80 exceeds maximum of 64 bits.
HINT:  Reduce occur_bitlen or kmer_size so that (kmer_size * 2 + occur_bitlen) <= 64.
\set ON_ERROR_STOP on
SET kmersearch.min_shared_ngram_key_rate = 0.0;  -- minimum
SHOW kmersearch.min_shared_ngram_key_rate;
 kmersearch.min_shared_ngram_key_rate 
--------------------------------------
 0
(1 row)

SET kmersearch.min_shared_ngram_key_rate = 1.0;  -- maximum
SHOW kmersearch.min_shared_ngram_key_rate;
 kmersearch.min_shared_ngram_key_rate 
--------------------------------------
 1
(1 row)

SET kmersearch.query_pattern_cache_max_entries = 1000;  -- minimum
SHOW kmersearch.query_pattern_cache_max_entries;
 kmersearch.query_pattern_cache_max_entries 
--------------------------------------------
 1000
(1 row)

SET kmersearch.query_pattern_cache_max_entries = 10000000;  -- maximum
SHOW kmersearch.query_pattern_cache_max_entries;
 kmersearch.query_pattern_cache_max_entries 
--------------------------------------------
 10000000
(1 row)

-- Test invalid values (should error)
\set ON_ERROR_STOP off
SET kmersearch.kmer_size = 3;   -- below minimum
ERROR:  3 is outside the valid range for parameter "kmersearch.kmer_size" (4 .. 32)
SET kmersearch.kmer_size = 33;  -- above maximum
ERROR:  33 is outside the valid range for parameter "kmersearch.kmer_size" (4 .. 32)
SET kmersearch.occur_bitlen = -1; -- below minimum  
ERROR:  -1 is outside the valid range for parameter "kmersearch.occur_bitlen" (0 .. 16)
SET kmersearch.occur_bitlen = 17; -- above maximum
ERROR:  17 is outside the valid range for parameter "kmersearch.occur_bitlen" (0 .. 16)
SET kmersearch.max_appearance_rate = -0.1; -- below minimum
ERROR:  -0.1 is outside the valid range for parameter "kmersearch.max_appearance_rate" (0 .. 1)
SET kmersearch.max_appearance_rate = 1.1; -- above maximum
ERROR:  1.1 is outside the valid range for parameter "kmersearch.max_appearance_rate" (0 .. 1)
SET kmersearch.min_shared_ngram_key_rate = -0.1;  -- below minimum
ERROR:  -0.1 is outside the valid range for parameter "kmersearch.min_shared_ngram_key_rate" (0 .. 1)
SET kmersearch.min_shared_ngram_key_rate = 1.1;   -- above maximum
ERROR:  1.1 is outside the valid range for parameter "kmersearch.min_shared_ngram_key_rate" (0 .. 1)
SET kmersearch.query_pattern_cache_max_entries = 999;  -- below minimum
ERROR:  999 is outside the valid range for parameter "kmersearch.query_pattern_cache_max_entries" (1000 .. 10000000)
SET kmersearch.query_pattern_cache_max_entries = 10000001;  -- above maximum
ERROR:  10000001 is outside the valid range for parameter "kmersearch.query_pattern_cache_max_entries" (1000 .. 10000000)
SET kmersearch.actual_min_score_cache_max_entries = 999;  -- below minimum
ERROR:  999 is outside the valid range for parameter "kmersearch.actual_min_score_cache_max_entries" (1000 .. 10000000)
SET kmersearch.actual_min_score_cache_max_entries = 10000001;  -- above maximum
ERROR:  10000001 is outside the valid range for parameter "kmersearch.actual_min_score_cache_max_entries" (1000 .. 10000000)
\set ON_ERROR_STOP on
-- Test that valid values still work after errors
SHOW kmersearch.kmer_size; -- should still be 32
 kmersearch.kmer_size 
----------------------
 32
(1 row)

SHOW kmersearch.occur_bitlen; -- should still be 0
 kmersearch.occur_bitlen 
-------------------------
 0
(1 row)

-- Test combinations of kmer_size and occur_bitlen
SET kmersearch.kmer_size = 4;
SET kmersearch.occur_bitlen = 8;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 4
(1 row)

SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 8
(1 row)

-- Total: 4*2+8=16 bits (valid)
SET kmersearch.kmer_size = 8;
SET kmersearch.occur_bitlen = 8;  
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 8
(1 row)

SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 8
(1 row)

-- Total: 8*2+8=24 bits (valid)
SET kmersearch.kmer_size = 16;
SET kmersearch.occur_bitlen = 8;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 16
(1 row)

SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 8
(1 row)

-- Total: 16*2+8=40 bits (valid)
SET kmersearch.kmer_size = 27;
SET kmersearch.occur_bitlen = 10;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 27
(1 row)

SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 10
(1 row)

-- Total: 27*2+10=64 bits (valid, maximum)
\set ON_ERROR_STOP off
SET kmersearch.kmer_size = 28; -- 28*2+10=66 > 64 (should fail)
ERROR:  invalid kmersearch.kmer_size value
DETAIL:  Total bit length (kmer_size * 2 + occur_bitlen) = (28 * 2 + 10) = 66 exceeds maximum of 64 bits.
HINT:  Reduce kmer_size or occur_bitlen so that (kmer_size * 2 + occur_bitlen) <= 64.
\set ON_ERROR_STOP on
SHOW kmersearch.kmer_size; -- should still be 27
 kmersearch.kmer_size 
----------------------
 27
(1 row)

-- Reset to defaults for other tests (ensure consistency across tests)
SET kmersearch.kmer_size = 16;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 16
(1 row)

SET kmersearch.occur_bitlen = 8;
SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 8
(1 row)

SET kmersearch.max_appearance_rate = 0.5;
SHOW kmersearch.max_appearance_rate;
 kmersearch.max_appearance_rate 
--------------------------------
 0.5
(1 row)

SET kmersearch.max_appearance_nrow = 0;
SHOW kmersearch.max_appearance_nrow;
 kmersearch.max_appearance_nrow 
--------------------------------
 0
(1 row)

SET kmersearch.min_score = 1;
SHOW kmersearch.min_score;
 kmersearch.min_score 
----------------------
 1
(1 row)

SET kmersearch.min_shared_ngram_key_rate = 0.2;
SHOW kmersearch.min_shared_ngram_key_rate;
 kmersearch.min_shared_ngram_key_rate 
--------------------------------------
 0.2
(1 row)

SET kmersearch.query_pattern_cache_max_entries = 50000;
SHOW kmersearch.query_pattern_cache_max_entries;
 kmersearch.query_pattern_cache_max_entries 
--------------------------------------------
 50000
(1 row)

SET kmersearch.actual_min_score_cache_max_entries = 50000;
SHOW kmersearch.actual_min_score_cache_max_entries;
 kmersearch.actual_min_score_cache_max_entries 
-----------------------------------------------
 50000
(1 row)

-- Test cache management functions
SELECT kmersearch_query_pattern_cache_stats(); -- Should show all zeros initially
 kmersearch_query_pattern_cache_stats 
--------------------------------------
 (0,0,0,0)
(1 row)

SELECT kmersearch_actual_min_score_cache_stats(); -- Should show all zeros initially
 kmersearch_actual_min_score_cache_stats 
-----------------------------------------
 (0,0,0,0)
(1 row)

SELECT kmersearch_query_pattern_cache_free();  -- Should return 0 (no entries to free)
 kmersearch_query_pattern_cache_free 
-------------------------------------
                                   0
(1 row)

DROP EXTENSION pg_kmersearch CASCADE;
SET client_min_messages = NOTICE;
