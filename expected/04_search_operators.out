SET client_min_messages = WARNING;
CREATE EXTENSION IF NOT EXISTS pg_kmersearch;
-- Set consistent GUC variables for this test
SET kmersearch.kmer_size = 4;
SHOW kmersearch.kmer_size;
 kmersearch.kmer_size 
----------------------
 4
(1 row)

SET kmersearch.occur_bitlen = 8;
SHOW kmersearch.occur_bitlen;
 kmersearch.occur_bitlen 
-------------------------
 8
(1 row)

SET kmersearch.max_appearance_rate = 0.5;
SHOW kmersearch.max_appearance_rate;
 kmersearch.max_appearance_rate 
--------------------------------
 0.5
(1 row)

SET kmersearch.max_appearance_nrow = 0;
SHOW kmersearch.max_appearance_nrow;
 kmersearch.max_appearance_nrow 
--------------------------------
 0
(1 row)

SET kmersearch.min_shared_kmer_rate = 0.2;  -- Allow matches with 20% shared k-mers
SHOW kmersearch.min_shared_kmer_rate;
 kmersearch.min_shared_kmer_rate 
---------------------------------
 0.2
(1 row)

-- Test k-mer search operators and functionality
-- This test covers the =% operator and search functionality
-- Clean up any existing tables
DROP TABLE IF EXISTS test_dna2_sequences, test_dna4_sequences CASCADE;
-- Create test tables for this test
CREATE TABLE test_dna2_sequences (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA2
);
CREATE TABLE test_dna4_sequences (
    id SERIAL PRIMARY KEY,
    name TEXT,
    sequence DNA4
);
-- Insert test data
INSERT INTO test_dna2_sequences (name, sequence) VALUES
    ('seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('seq2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('seq3', 'ATCGATCGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT');
INSERT INTO test_dna4_sequences (name, sequence) VALUES
    ('seq1', 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGA'),
    ('seq2', 'GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA'),
    ('seq3', 'ATCGATCGNNATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATC');
-- Create GIN indexes
-- With k=4 and occur_bitlen=8, total bits = 4*2+8 = 16, so we can use int2 operator class
CREATE INDEX idx_DNA2_gin ON test_dna2_sequences USING gin (sequence kmersearch_dna2_gin_ops_int2);
CREATE INDEX idx_DNA4_gin ON test_dna4_sequences USING gin (sequence kmersearch_dna4_gin_ops_int2);
-- Test =% operator with DNA2
SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'ATCGATCG' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'GCTAG' ORDER BY id;
 id | name 
----+------
  2 | seq2
(1 row)

SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'TTTTTTTT' ORDER BY id;
 id | name 
----+------
  3 | seq3
(1 row)

-- Test =% operator with DNA4
SELECT id, name FROM test_dna4_sequences WHERE sequence =% 'ATCGATCG' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

SELECT id, name FROM test_dna4_sequences WHERE sequence =% 'GCTAG' ORDER BY id;
 id | name 
----+------
  2 | seq2
(1 row)

SELECT id, name FROM test_dna4_sequences WHERE sequence =% 'NNATCG' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

-- Test query length validation (should work with 4+ characters when k=4)
SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'ATCGATCG' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

-- Test too short query (should error)
\set ON_ERROR_STOP off
SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'ATC';  -- 3 chars, k=4, should error
ERROR:  Query sequence must be at least 4 bases long
SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'AT';   -- 2 chars, k=4, should error  
ERROR:  Query sequence must be at least 4 bases long
SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'A';    -- 1 char, k=4, should error
ERROR:  Query sequence must be at least 4 bases long
SELECT id, name FROM test_dna2_sequences WHERE sequence =% '';     -- empty, k=4, should error
ERROR:  Query sequence must be at least 4 bases long
SELECT id, name FROM test_dna4_sequences WHERE sequence =% 'ATC';  -- 3 chars, k=4, should error
ERROR:  Query sequence must be at least 4 bases long
\set ON_ERROR_STOP on
-- Test exact k-mer size query (should work)
SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'ATCG' ORDER BY id;  -- exactly 4 chars
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

-- Test case insensitivity in queries
SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'atcgatcg' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

SELECT id, name FROM test_dna4_sequences WHERE sequence =% 'atcgatcg' ORDER BY id;
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

-- Test different query patterns
SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'GCTAGCTA' ORDER BY id; -- should match seq2
 id | name 
----+------
  2 | seq2
(1 row)

SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'TTTTTTTT' ORDER BY id; -- should match seq3
 id | name 
----+------
  3 | seq3
(1 row)

SELECT id, name FROM test_dna2_sequences WHERE sequence =% 'AAAAAAAA' ORDER BY id; -- should not match any
 id | name 
----+------
(0 rows)

-- Test DNA4 with degenerate bases
SELECT id, name FROM test_dna4_sequences WHERE sequence =% 'NNATCG' ORDER BY id;   -- contains N
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

SELECT id, name FROM test_dna4_sequences WHERE sequence =% 'ATCGNN' ORDER BY id;   -- contains N
 id | name 
----+------
  1 | seq1
  3 | seq3
(2 rows)

-- Test scoring functions with different patterns
SELECT id, name, kmersearch_matchscore(sequence, 'ATCGATCG') as score 
FROM test_dna2_sequences ORDER BY score DESC, id;
 id | name | score 
----+------+-------
  1 | seq1 |     5
  3 | seq3 |     5
  2 | seq2 |     0
(3 rows)

-- Clean up test tables
DROP TABLE IF EXISTS test_dna2_sequences CASCADE;
DROP TABLE IF EXISTS test_dna4_sequences CASCADE;
DROP EXTENSION pg_kmersearch CASCADE;
SET client_min_messages = NOTICE;
